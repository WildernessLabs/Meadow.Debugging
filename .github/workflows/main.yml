name: Build All IDE Extensions (Centralized)

env:
  IDE_TOOLS_RELEASE_VERSION: 3.0.0
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-host:
    runs-on: windows-latest
    name: Build Meadow Debugging Host
    
    steps:
    - name: Checkout Meadow.Debugging repo
      uses: actions/checkout@v4
      with:
        path: Meadow.Debugging
        submodules: true

    - name: Checkout VSCode_Meadow_Extension side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/VSCode_Meadow_Extension
        path: VSCode_Meadow_Extension
        ref: dominique-DAPRefactor

    - name: Checkout VS_Win_Meadow_Extension side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/VS_Win_Meadow_Extension
        path: VS_Win_Meadow_Extension
        ref: dominique-DAPRefactor

    - name: Checkout Rider_Meadow_Plugin side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/Rider_Meadow_Plugin
        path: Rider_Meadow_Plugin
        ref: dominique-DAPRefactor

    - name: Setup .NET 8.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore Meadow.Debugging dependencies
      run: dotnet restore Meadow.Debugging/Meadow.Debugging.sln
      
    - name: Build Meadow.Debugging.Host (Release)
      run: dotnet build Meadow.Debugging/Meadow.Debugging.Host/Meadow.Debugging.Host.csproj -c Release --no-restore
      
    - name: Build Meadow.Debugging.Host (Debug)
      run: dotnet build Meadow.Debugging/Meadow.Debugging.Host/Meadow.Debugging.Host.csproj -c Debug --no-restore
      
    - name: Upload Host artifacts (Debug)
      uses: actions/upload-artifact@v4
      with:
        name: meadow-debugging-host-debug
        path: |
          Meadow.Debugging/Meadow.Debugging.Host/bin/Debug/net8.0/meadow-debugging.*
          
    - name: Upload Host artifacts (Release)
      uses: actions/upload-artifact@v4
      with:
        name: meadow-debugging-host-release
        path: |
          Meadow.Debugging/Meadow.Debugging.Host/bin/Release/net8.0/meadow-debugging.*

  build-ide-extensions:
    needs: build-host
    runs-on: windows-latest
    strategy:
      matrix:
        ide: [vscode, vs2022, rider]
      fail-fast: false
    name: Build ${{ matrix.ide }} Extension
    
    steps:
    - name: Checkout Meadow.Debugging repo
      uses: actions/checkout@v4
      with:
        path: Meadow.Debugging
        submodules: true

    - name: Checkout VSCode_Meadow_Extension side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/VSCode_Meadow_Extension
        path: VSCode_Meadow_Extension
        ref: ${{ github.ref_name }}

    - name: Checkout VS_Win_Meadow_Extension side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/VS_Win_Meadow_Extension
        path: VS_Win_Meadow_Extension
        ref: ${{ github.ref_name }}

    - name: Checkout Rider_Meadow_Plugin side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/Rider_Meadow_Plugin
        path: Rider_Meadow_Plugin
        ref: ${{ github.ref_name }}

    - name: Checkout Meadow.CLI side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/Meadow.CLI
        path: Meadow.CLI
        ref: ${{ github.ref == 'refs/heads/main' && 'main' || 'develop' }}

    - name: Checkout Meadow.Contracts side-by-side
      uses: actions/checkout@v4
      with:
        repository: WildernessLabs/Meadow.Contracts
        path: Meadow.Contracts
        ref: develop

    - name: Setup .NET 8.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Node.js 20 (for VSCode)
      if: matrix.ide == 'vscode'
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install vsce and debugprotocol (for VSCode)
      if: matrix.ide == 'vscode'
      run: |
        npm i -g @vscode/vsce
        npm i -g @vscode/debugprotocol

    - name: Add MSBuild to Path (for VS2022)
      if: matrix.ide == 'vs2022'
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '[17.0, 18.0)'

    # VSCode Build
    - name: Restore VSCode Extension dependencies
      if: matrix.ide == 'vscode'
      run: dotnet restore VSCode_Meadow_Extension/src/csharp/VSCodeMeadow.sln

    - name: Build VSCode Extension
      if: matrix.ide == 'vscode'
      run: dotnet build VSCode_Meadow_Extension/src/csharp/VSCodeMeadow.sln -c Release --no-restore

    - name: Build VSCode WebPack
      if: matrix.ide == 'vscode'
      run: |
        cd VSCode_Meadow_Extension
        npm install -g webpack
        npm install -D ts-loader
        npm run webpack

    - name: Package VSCode VSIX
      if: matrix.ide == 'vscode'
      run: |
        cd VSCode_Meadow_Extension
        vsce package

    - name: Upload VSCode VSIX
      if: matrix.ide == 'vscode'
      uses: actions/upload-artifact@v4
      with:
        name: meadow-vscode-extension
        path: VSCode_Meadow_Extension/*.vsix

    # VS2022 Build
    - name: Restore VS2022 dependencies
      if: matrix.ide == 'vs2022'
      run: msbuild VS_Win_Meadow_Extension/VS_Meadow_Extension.2022.sln /t:Restore /p:Configuration=Release

    - name: Build VS2022 Extension
      if: matrix.ide == 'vs2022'
      run: msbuild VS_Win_Meadow_Extension/VS_Meadow_Extension.2022.sln /t:Rebuild /p:Configuration=Release
      env:
        DevEnvDir: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE'

    - name: Upload VS2022 VSIX
      if: matrix.ide == 'vs2022'
      uses: actions/upload-artifact@v4
      with:
        name: meadow-vs2022-extension
        path: |
          VS_Win_Meadow_Extension/VS_Meadow_Extension/VS_Meadow_Extension.2022/bin/Release/*.vsix

    # Rider Build
    - name: Build Rider Backend
      if: matrix.ide == 'rider'
      run: dotnet build Rider_Meadow_Plugin -c Release

    - name: Build Rider Distribution
      if: matrix.ide == 'rider'
      run: ./gradlew -PbuildConfiguration=Release -PbuildNumber=${{ github.run_number }} buildPlugin
      working-directory: Rider_Meadow_Plugin

    - name: Unpack Rider distribution
      if: matrix.ide == 'rider'
      shell: pwsh
      run: Rider_Meadow_Plugin/scripts/Unpack-Distribution.ps1

    - name: Read Rider version
      if: matrix.ide == 'rider'
      id: read_version
      run: |
        $content = Get-Content Rider_Meadow_Plugin/gradle.properties | Select-String 'pluginVersion='
        $version = $content -replace 'pluginVersion=', ''
        echo "plugin_version=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Upload Rider Plugin
      if: matrix.ide == 'rider'
      uses: actions/upload-artifact@v4
      with:
        name: meadow-rider-plugin-${{ env.plugin_version }}
        path: Rider_Meadow_Plugin/build/distributions/unpacked

  test-all:
    needs: [build-host, build-ide-extensions]
    runs-on: windows-latest
    name: Verify All Artifacts
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List all artifacts
      run: |
        Get-ChildItem -Recurse
        Write-Host "=== Verification ==="
        Write-Host "Host artifacts downloaded: $(Test-Path '*meadow-debugging-host*')"
        Write-Host "VSCode extension downloaded: $(Test-Path '*meadow-vscode*')"
        Write-Host "VS2022 extension downloaded: $(Test-Path '*meadow-vs2022*')"
        Write-Host "Rider plugin downloaded: $(Test-Path '*meadow-rider*')"
